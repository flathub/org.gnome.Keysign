id: org.gnome.Keysign
runtime: org.gnome.Platform
runtime-version: '3.38'
sdk: org.gnome.Sdk
command: gnome-keysign
copy-icon: true
finish-args:
  - --share=ipc
  - --socket=x11
  # We are not Wayland ready yet, because of Twisted: https://github.com/flathub/org.gnome.Keysign/issues/14
  #- --socket=fallback-x11
  #- --socket=wayland
  - --share=network
  - --system-talk-name=org.freedesktop.Avahi
  - --system-talk-name=org.bluez
  - --allow=bluetooth
  - --device=all
  - --filesystem=~/.gnupg:ro
  - --filesystem=xdg-run/gnupg:ro
  # We use this folder to support dragging and dropping emails into the app
  # There might be a copy-and-paste portal: https://github.com/flatpak/xdg-desktop-portal/issues/99
  # And Evolution might be capable of sending the whole email via the clipboard: https://gitlab.gnome.org/GNOME/evolution/issues/618
  # Until any of that has landed, we make the folder read-only.
  - --filesystem=xdg-cache/evolution/tmp:ro
  - --filesystem=~/.claws-mail/tmp/:ro

# We're waiting for webcam support: https://github.com/flatpak/xdg-desktop-portal/issues/38;
# we use --device=all meanwhile. We do network, because we're opening a port.
build-options:
  env:
    V: '1'
cleanup:
  - /include
  - /lib/pkgconfig
  - /share/pkgconfig
  - /share/aclocal
  - /man
  - /share/man
  - /share/gtk-doc
  - /share/vala
  - "*.la"
  - "*.a"
modules:
  - name: swig
    config-opts:
      - "--without-boost"
      - "--without-pcre"
    sources:
      - type: archive
        url: http://prdownloads.sourceforge.net/swig/swig-3.0.12.tar.gz
        sha256: 7cf9f447ae7ed1c51722efc45e7f14418d15d7a1e143ac9f09a668999f4fc94d

  - name: python3-dbus-python
    buildsystem: simple
    ensure-writable:
      - easy-install.pth
      - setuptools.pth
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} dbus-python
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/3f/e7/4edb582d1ffd5ac3c84188deea32e960b5c8c0fe1da56ce70224f85ce542/dbus-python-1.2.8.tar.gz
        sha256: abf12bbb765e300bf8e2a1b2f32f85949eab06998dbda127952c31cb63957b6f



  - name: gst-plugins-bad
    buildsystem: meson
    config-opts:
        - -Dexamples=disabled
        - -Daom=disabled
        - -Davtp=disabled
        - -Dbs2b=disabled
        - -Dchromaprint=disabled
        - -Dcolormanagement=disabled
        - -Dcuda=disabled
        - -Dcurl-ssh2=disabled
        - -Dcurl=disabled
        - -Dd3dvideosink=disabled
        - -Ddash=disabled
        - -Ddc1394=disabled
        - -Ddecklink=disabled
        - -Ddirectfb=disabled
        - -Ddirectsound=disabled
        - -Ddoc=disabled
        - -Ddtls=disabled
        - -Ddts=disabled
        - -Dfaac=disabled
        - -Dfbdev=disabled
        - -Dfestival=disabled
        - -Dflite=disabled
        - -Dfluidsynth=disabled
        - -Dgme=disabled
        - -Dgsm=disabled
        - -Diqa=disabled
        - -Dladspa=disabled
        - -Dlibde265=disabled
        - -Dlibmms=disabled
        - -Dlv2=disabled
        - -Dmagicleap=disabled
        - -Dmicrodns=disabled
        - -Dmodplug=disabled
        - -Dmpeg2enc=disabled
        - -Dmplex=disabled
        - -Dmsdk=disabled
        - -Dmusepack=disabled
        - -Dneon=disabled
        - -Dnvcodec=disabled
        - -Dnvdec=disabled
        - -Dnvenc=disabled
        - -Dofa=disabled
        - -Dopenal=disabled
        - -Dopencv=disabled
        - -Dopenexr=disabled
        - -Dopenh264=disabled
        - -Dopenmpt=disabled
        - -Dopenni2=disabled
        - -Dopensles=disabled
        - -Dresindvd=disabled
        - -Drsvg=disabled
        - -Drtmp=disabled
        - -Drtp=disabled
        - -Dsbc=disabled
        - -Dsctp=disabled
        - -Dsndfile=disabled
        - -Dsoundtouch=disabled
        - -Dspandsp=disabled
        - -Dsrt=disabled
        - -Dsvthevcenc=disabled
        - -Dteletext=disabled
        - -Dtinyalsa=disabled
        - -Dva=disabled
        - -Dvaacenc=disabled
        - -Dvdpau=disabled
        - -Dvoaacenc=disabled
        - -Dvoamrwbenc=disabled
        - -Dvulkan=disabled
        - -Dwasapi=disabled
        - -Dwasapi2=disabled
        - -Dwebp=disabled
        - -Dwebrtcdsp=disabled
        - -Dwebrtc=disabled
        - -Dwildmidi=disabled
        - -Dwinks=disabled
        - -Dwinscreencap=disabled
        - -Dwpe=disabled
        - -Dzbar=enabled
        - -Dzxing=enabled
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-plugins-bad/gst-plugins-bad-1.16.3.tar.xz
        sha256: 84efe57011658f0a53a5d5b20f64ef109f5105dccb0808c21e069e946673514d

    modules:
      - name: zbar
        build-options:
          config-opts:
            - "--disable-video"
            - "--without-xv"
            - "--without-python2"
            - "--without-gtk"
            - "--without-qt"
        sources:
          - type: git
            url: git://git.linuxtv.org/zbar.git
            commit: edcf08b49e0a5fe71c18fa9d4b8ed83ed8fc9082
          - type: shell
            commands:
                # Patch for Imagemagick 7 https://git.archlinux.org/svntogit/community.git/tree/trunk/imagemagick7.patch?h=packages/zbar&id=f80dc934f730ee4204dc51f3ef47cd2ec7406898
                - sed -i 's|wand/MagickWand.h|MagickWand/MagickWand.h|g' configure.ac
                - sed -i 's|wand/MagickWand.h|MagickWand/MagickWand.h|g' zbarimg/zbarimg.c
                # Avoid documentation
                - sed -i '48d' Makefile.am
          - type: script
            dest-filename: autogen.sh
            commands:
                - autoreconf -vfi -W none
        modules:
          - name: ImageMagick
            sources:
              - type: archive
                url: https://github.com/ImageMagick/ImageMagick/archive/7.0.8-12.tar.gz
                sha256: cd3a25183d433f3ad4f8ed6301c5ae5dfb0959c1f09b059acee447bb3881bf99

  - name: gpgme
    sources:
      - type: archive
        url: https://www.gnupg.org/ftp/gcrypt/gpgme/gpgme-1.12.0.tar.bz2
        sha256: b4dc951c3743a60e2e120a77892e9e864fb936b2e58e7c77e8581f4d050e8cd8

  - name: libical
    cleanup:
    - "/lib/cmake"
    buildsystem: cmake
    config-opts:
    - "-DCMAKE_INSTALL_LIBDIR:PATH=/app/lib"
    - "-DBUILD_SHARED_LIBS:BOOL=ON"
    sources:
    - type: archive
      url: https://github.com/libical/libical/archive/v3.0.5.tar.gz
      sha256: 483acbf7fee66ca071c2ff8183e46b6f2b3a89e1e866eadf4870eaaa281c8db1

  - name: bluez
    config-opts:
    - "--disable-datafiles"
    - "--disable-systemd"
    - "--enable-experimental"
    - "--enable-library"
    - "--disable-client"
    - "--disable-mesh"
    - "--disable-tools"
    - "--disable-monitor"
    - "--disable-udev"
    - "--prefix=/app"
    - "--sysconfdir=/app/etc"
    sources:
    - type: archive
      url: https://mirrors.edge.kernel.org/pub/linux/bluetooth/bluez-5.50.tar.xz
      sha256: 5ffcaae18bbb6155f1591be8c24898dc12f062075a40b538b745bfd477481911

    - type: patch
      path: cf7d8a23325784ffc1fc48aa11171e3068c3ace5..f36f71f60b1e68c0f12e615b9b128d089ec3dd19.patch

  # flatpak-pip-generator  --runtime org.gnome.Sdk//3.38 --build-isolation  requests  qrcode  twisted[tls]   future  magic-wormhole
  # as parsing requirements.txt doesn't seem to work O_o
  - python3-modules.json

  - name: gnome-keysign
    no-autogen: true
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/gnome-keysign/-/archive/1.2.0/gnome-keysign-1.2.0.tar.gz
        sha256: 81e404a535ea94e5dde699ea386d795cfc1494bbcd6f28fb6940b9fa7da9f5b1

      - type: patch
        path: 0001-setup-import-translate_appdata_file-and-translate_de.patch
